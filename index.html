<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Weather - Final Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #74b9ff; transition: background 1s ease; }
        body.sunny { background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); }
        body.rainy { background: linear-gradient(135deg, #373B44 0%, #4286f4 100%); }
        body.cloudy { background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%); }
        .app-container { display: flex; gap: 20px; width: 900px; height: 85vh; max-width: 95%; z-index: 10; }
        .card { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(20px); border-radius: 24px; padding: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.15); flex: 1; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.6); }
        .search-row { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 15px; outline: none; font-size: 1rem; }
        button { padding: 0 25px; border: none; background: #6C5CE7; color: white; border-radius: 15px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .weather-content { text-align: center; margin: auto 0; }
        .temp { font-size: 5rem; font-weight: 800; color: #2d3436; margin: 10px 0; }
        .city { font-size: 2rem; color: #636e72; font-weight: 600; }
        .icon-display { font-size: 5rem; display: block; }
        .stats { display: flex; justify-content: space-around; margin-top: 40px; padding-top: 20px; border-top: 2px solid rgba(0,0,0,0.05); }
        .chat-area { flex: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; border-radius: 15px; margin: 15px 0; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 18px; border-radius: 15px; font-size: 0.95rem; line-height: 1.5; max-width: 85%; }
        .msg.ai { background: #fff; color: #333; align-self: flex-start; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.user { background: #6C5CE7; color: white; align-self: flex-end; }
    </style>
</head>
<body id="main-body">
    <div class="app-container">
        <div class="card">
            <div class="search-row">
                <input type="text" id="cityIn" placeholder="Enter City..." value="London">
                <button id="searchBtn">üîç</button>
            </div>
            <div class="weather-content">
                <span id="w-icon" class="icon-display">‚õÖ</span>
                <div id="w-temp" class="temp">--¬∞</div>
                <div id="w-city" class="city">Search City</div>
                <div id="w-desc" style="text-transform: capitalize; margin-top: 10px;">--</div>
                <div class="stats">
                    <div class="stat-box"><span>üíß Humidity</span><strong id="w-humidity">--%</strong></div>
                    <div class="stat-box"><span>üí® Wind</span><strong id="w-wind">-- m/s</strong></div>
                </div>
            </div>
        </div>
        <div class="card">
            <div class="chat-header"><h3>‚ú® Gemini Assistant</h3></div>
            <div class="chat-area" id="chat-box"><div class="msg ai">Hello! Search a city to begin.</div></div>
            <div class="search-row" style="margin-bottom: 0;">
                <input type="text" id="aiIn" placeholder="Ask about the weather...">
                <button id="askBtn">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let weatherData = null;
        document.getElementById('searchBtn').addEventListener('click', getWeather);
        document.getElementById('askBtn').addEventListener('click', askGemini);

        async function getWeather() {
            const city = document.getElementById('cityIn').value;
            if(!city) return;
            try {
                const res = await fetch('/.netlify/functions/api-bridge', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'weather', city: city })
                });
                const data = await res.json();
                weatherData = data;
                updateUI(data);
            } catch (err) { document.getElementById('w-city').innerText = "Not Found"; }
        }

        async function askGemini() {
            const input = document.getElementById('aiIn');
            const text = input.value.trim();
            if(!text) return;
            addMsg(text, 'user');
            input.value = '';

            try {
                let context = "You are a weather assistant.";
                if(weatherData) {
                    context += ` Weather in ${weatherData.name}: ${weatherData.weather[0].main}, ${Math.round(weatherData.main.temp)}¬∞C.`;
                }
                const res = await fetch('/.netlify/functions/api-bridge', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'ai', prompt: `${context} User asks: "${text}". Keep it short.` })
                });
                const data = await res.json();
                
                // DATA EXTRACTION FIX
                if (data.candidates && data.candidates[0].content) {
                    addMsg(data.candidates[0].content.parts[0].text, 'ai');
                } else if (data.error) {
                    addMsg("‚ùå AI Error: " + (data.error.message || "Unknown error"), "ai");
                }
            } catch (err) { addMsg("‚ùå Bridge Error.", "ai"); }
        }

        function updateUI(data) {
            document.getElementById('w-temp').innerText = Math.round(data.main.temp) + "¬∞";
            document.getElementById('w-city').innerText = data.name;
            document.getElementById('w-desc').innerText = data.weather[0].description;
            document.getElementById('w-humidity').innerText = data.main.humidity + "%";
            document.getElementById('w-wind').innerText = data.wind.speed + " m/s";
            const main = data.weather[0].main.toLowerCase();
            const body = document.getElementById('main-body');
            body.className = '';
            if(main.includes('rain')) body.classList.add('rainy');
            else if(main.includes('clear')) body.classList.add('sunny');
            else body.classList.add('cloudy');
        }

        function addMsg(txt, type) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = txt;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }
        window.onload = getWeather;
    </script>
</body>
</html>
